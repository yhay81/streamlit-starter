# ============================================================================
# ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®šï¼ˆç’°å¢ƒå¤‰æ•°ã§ä¸Šæ›¸ãå¯ï¼‰
# ============================================================================
AWS_PROFILE ?= default
AWS_REGION  ?= ap-northeast-1
ECR_REPO    ?= streamlit-suite
TAG         ?= $(shell git -C $(ROOT_DIR) rev-parse --short HEAD)

# å¤‰æ•°æ´¾ç”Ÿ
ACCOUNT_ID  := $(shell aws sts get-caller-identity  \
                      --profile $(AWS_PROFILE) --query Account --output text)
ECR_URI     := $(ACCOUNT_ID).dkr.ecr.$(AWS_REGION).amazonaws.com/$(ECR_REPO)
ROOT_DIR    := $(strip $(abspath $(CURDIR)/..))

# ============================================================================
# ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
# ============================================================================
.PHONY: login build push plan apply deploy destroy fmt

## 1) ECR ãƒ­ã‚°ã‚¤ãƒ³
login:
	@echo "ğŸ”‘  Logging in to ECR ($(AWS_PROFILE))"
	@aws ecr get-login-password --profile $(AWS_PROFILE) --region $(AWS_REGION) \
	    | docker login --username AWS --password-stdin \
	      $(ACCOUNT_ID).dkr.ecr.$(AWS_REGION).amazonaws.com

## 2) Docker ãƒ“ãƒ«ãƒ‰ï¼ˆlatest & TAGï¼‰
build:
	@echo "ğŸ³  Docker build: $(TAG)"
	docker build \
		-f $(ROOT_DIR)/Dockerfile \
		-t $(ECR_URI):$(TAG) \
		-t $(ECR_URI):latest \
		$(ROOT_DIR)

## 3) Docker ãƒ—ãƒƒã‚·ãƒ¥
push: login build
	@echo "ğŸ“¤  Pushing images to ECR"
	docker push $(ECR_URI):$(TAG)
	docker push $(ECR_URI):latest

## 4) Terraform plan
plan:
	@echo "ğŸ“‹  Terraform plan"
	terraform init -reconfigure -upgrade -input=false
	terraform plan -input=false -var="image_tag=$(TAG)" -out=plan.tfplan

## 5) Terraform apply
apply:
	@echo "ğŸš€  Terraform apply"
	terraform apply -input=false plan.tfplan

## 6) ä¸€æ‹¬ãƒ‡ãƒ—ãƒ­ã‚¤ â†’ build / push / plan / apply
deploy: push plan apply
	@echo "âœ…  Deploy complete!  Tag = $(TAG)"

## 7) statefmt
fmt:
	@terraform fmt -recursive

## 8) ç ´æ£„
destroy:
	terraform destroy -var="image_tag=$(TAG)"
