# ============================================================================
# ÂÖ±ÈÄö ‚Äì Â§âÊï∞
# ============================================================================
AWS_PROFILE ?= default
AWS_REGION  ?= ap-northeast-1

# ‚îÄ‚îÄ Streamlit AppÔºàÊó¢Â≠òÔºâ
APP_ECR_REPO ?= streamlit-suite
APP_DOCKERFILE ?= $(ROOT_DIR)/Dockerfile
APP_CONTEXT    ?= $(ROOT_DIR)

# ‚îÄ‚îÄ Nginx ProxyÔºàÊñ∞Ë¶èÔºâ
PROXY_ECR_REPO ?= streamlit-proxy
PROXY_DOCKERFILE ?= $(ROOT_DIR)/infra/proxy/Dockerfile
PROXY_CONTEXT    ?= $(ROOT_DIR)/infra/proxy

# Git SHA „Çí„Çø„Ç∞„Å´Âà©Áî®
TAG ?= $(shell git -C $(ROOT_DIR) rev-parse --short HEAD)

# ‰æøÂà©Â§âÊï∞
ACCOUNT_ID := $(shell aws sts get-caller-identity \
	                --profile $(AWS_PROFILE) --query Account --output text)
ECR_URI     = $(ACCOUNT_ID).dkr.ecr.$(AWS_REGION).amazonaws.com
APP_ECR_URI    = $(ECR_URI)/$(APP_ECR_REPO)
PROXY_ECR_URI  = $(ECR_URI)/$(PROXY_ECR_REPO)
ROOT_DIR   := $(strip $(abspath $(CURDIR)/..))

.PHONY: login build build-app build-proxy push push-app push-proxy \
        plan apply deploy deploy-all fmt destroy

# ============================================================================
# 0) ECR „É≠„Ç∞„Ç§„É≥
# ============================================================================
login:
	@echo "üîë  Logging in to ECR ($(AWS_PROFILE))"
	@aws ecr get-login-password --profile $(AWS_PROFILE) --region $(AWS_REGION) \
	    | docker login --username AWS --password-stdin $(ECR_URI)

# ============================================================================
# 1) Docker „Éì„É´„Éâ
# ============================================================================
build: build-app build-proxy

build-app:
	@echo "üê≥  [App] Docker build: $(TAG)"
	docker build --platform linux/amd64 \
		-f $(APP_DOCKERFILE) \
		-t $(APP_ECR_URI):$(TAG) \
		-t $(APP_ECR_URI):latest \
		$(APP_CONTEXT)

build-proxy:
	@echo "üê≥  [Proxy] Docker build: $(TAG)"
	docker build --platform linux/amd64 \
		-f $(PROXY_DOCKERFILE) \
		-t $(PROXY_ECR_URI):$(TAG) \
		-t $(PROXY_ECR_URI):latest \
		$(PROXY_CONTEXT)

# ============================================================================
# 2) Docker „Éó„ÉÉ„Ç∑„É•
# ============================================================================
push: push-app push-proxy

push-app: login build-app
	@echo "üì§  [App] Pushing images to ECR"
	docker push $(APP_ECR_URI):$(TAG)
	docker push $(APP_ECR_URI):latest

push-proxy: login build-proxy
	@echo "üì§  [Proxy] Pushing images to ECR"
	docker push $(PROXY_ECR_URI):$(TAG)
	docker push $(PROXY_ECR_URI):latest

# ============================================================================
# 3) Terraform
# ============================================================================
plan:
	@echo "üìã  Terraform plan"
	terraform init -reconfigure -upgrade -input=false
	terraform plan -input=false \
		-var="image_tag=$(TAG)" \
		-out=plan.tfplan

apply:
	@echo "üöÄ  Terraform apply"
	terraform apply -input=false plan.tfplan

# ============================================================================
# 4) „ÉØ„É≥„É©„Ç§„Éä„Éº
# ============================================================================
deploy: push plan apply
	@echo "‚úÖ  Deploy complete!  Tag = $(TAG)"

deploy-all: login build push plan apply

# ============================================================================
# „Åù„ÅÆ‰ªñ
# ============================================================================
fmt:
	@terraform fmt -recursive

destroy:
	terraform destroy -var="app_image_tag=$(TAG)" -var="proxy_image_tag=$(TAG)"
